{% extends 'dashboard/business_base.html' %}
{% load static %}

{% block title %}Reports & Analytics - {{ tenant.name }}{% endblock %}

{% block extra_css %}
<style>
    .reports-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }
    
    .reports-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
    }
    
    .period-selector {
        display: inline-flex;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 5px;
        margin-top: 15px;
    }
    
    .period-btn {
        padding: 8px 20px;
        border: none;
        background: transparent;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
    }
    
    .period-btn:hover,
    .period-btn.active {
        background: rgba(255, 255, 255, 0.3);
        color: white;
    }
    
    .metric-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        transition: all 0.3s;
        height: 100%;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.12);
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 15px 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .metric-label {
        color: #6c757d;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
    }
    
    .metric-change {
        display: inline-flex;
        align-items: center;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-top: 10px;
    }
    
    .metric-change.positive {
        background: #d4edda;
        color: #155724;
    }
    
    .metric-change.negative {
        background: #f8d7da;
        color: #721c24;
    }
    
    .metric-change.neutral {
        background: #e2e3e5;
        color: #383d41;
    }
    
    .report-card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        margin-bottom: 25px;
        transition: all 0.3s;
    }
    
    .report-card:hover {
        box-shadow: 0 10px 25px rgba(0,0,0,0.12);
    }
    
    .report-card h3 {
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .report-card h3 i {
        color: #667eea;
    }
    
    .chart-container {
        position: relative;
        height: 350px;
        margin-top: 20px;
    }
    
    .report-links {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }
    
    .report-link-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        text-decoration: none;
        transition: all 0.3s;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    
    .report-link-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        color: white;
    }
    
    .report-link-card i {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    
    .report-link-card h4 {
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 10px;
    }
    
    .report-link-card p {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .comparison-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<!-- Reports Header -->
<div class="reports-header">
    <h1><i class="bi bi-graph-up"></i> Reports & Analytics</h1>
    <p style="opacity: 0.9;">Comprehensive business insights and performance metrics</p>
    
    <div class="period-selector">
        <a href="?period=today" class="period-btn {% if period == 'today' %}active{% endif %}">Today</a>
        <a href="?period=week" class="period-btn {% if period == 'week' %}active{% endif %}">Week</a>
        <a href="?period=month" class="period-btn {% if period == 'month' %}active{% endif %}">Month</a>
        <a href="?period=quarter" class="period-btn {% if period == 'quarter' %}active{% endif %}">Quarter</a>
        <a href="?period=year" class="period-btn {% if period == 'year' %}active{% endif %}">Year</a>
    </div>
    
    <div style="margin-top: 15px; opacity: 0.9;">
        <small>
            <i class="bi bi-calendar3"></i> 
            {{ start_date|date:"M d, Y" }} - {{ end_date|date:"M d, Y" }}
        </small>
    </div>
</div>

<!-- Key Metrics Grid -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="metric-card">
            <div class="metric-label">Total Revenue</div>
            <div class="metric-value">{{ currency_symbol }}{{ revenue_stats.total_revenue|floatformat:2 }}</div>
            <div class="metric-change {% if comparison.revenue_growth > 0 %}positive{% elif comparison.revenue_growth < 0 %}negative{% else %}neutral{% endif %}">
                <i class="bi bi-{% if comparison.revenue_growth > 0 %}arrow-up{% elif comparison.revenue_growth < 0 %}arrow-down{% else %}dash{% endif %}"></i>
                {{ comparison.revenue_growth|floatformat:1 }}% vs previous period
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="metric-card">
            <div class="metric-label">Total Transactions</div>
            <div class="metric-value">{{ revenue_stats.total_transactions }}</div>
            <div class="metric-change {% if comparison.transaction_growth > 0 %}positive{% elif comparison.transaction_growth < 0 %}negative{% else %}neutral{% endif %}">
                <i class="bi bi-{% if comparison.transaction_growth > 0 %}arrow-up{% elif comparison.transaction_growth < 0 %}arrow-down{% else %}dash{% endif %}"></i>
                {{ comparison.transaction_growth|floatformat:1 }}% vs previous period
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="metric-card">
            <div class="metric-label">Active Customers</div>
            <div class="metric-value">{{ customer_metrics.active_customers }}</div>
            <div class="metric-change neutral">
                <i class="bi bi-people"></i>
                {{ customer_metrics.vip_customers }} VIP customers
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="metric-card">
            <div class="metric-label">Avg. Transaction Value</div>
            <div class="metric-value">{{ currency_symbol }}{{ revenue_stats.avg_transaction|floatformat:2 }}</div>
            <div class="metric-change neutral">
                <i class="bi bi-calculator"></i>
                Per transaction
            </div>
        </div>
    </div>
</div>

<!-- Revenue Chart -->
<div class="report-card">
    <h3>
        <i class="bi bi-graph-up"></i>
        Revenue Trend
    </h3>
    <div class="chart-container">
        <canvas id="revenueChart"></canvas>
    </div>
</div>

<!-- Additional Metrics Row -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="report-card">
            <h3>
                <i class="bi bi-people"></i>
                Customer Insights
            </h3>
            <div class="row text-center">
                <div class="col-6 mb-3">
                    <div class="metric-label">Total Customers</div>
                    <div class="metric-value" style="font-size: 2rem;">{{ customer_metrics.total_customers }}</div>
                </div>
                <div class="col-6 mb-3">
                    <div class="metric-label">Retention Rate</div>
                    <div class="metric-value" style="font-size: 2rem;">{{ retention_rate }}%</div>
                </div>
                <div class="col-12">
                    <div class="metric-label">Customer Lifetime Value</div>
                    <div class="metric-value" style="font-size: 2rem;">{{ currency_symbol }}{{ customer_metrics.avg_customer_value|floatformat:2 }}</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="report-card">
            <h3>
                <i class="bi bi-star"></i>
                Loyalty Program
            </h3>
            <div class="row text-center">
                <div class="col-6 mb-3">
                    <div class="metric-label">Points Issued</div>
                    <div class="metric-value" style="font-size: 2rem;">{{ loyalty_metrics.total_points_issued|floatformat:0 }}</div>
                </div>
                <div class="col-6 mb-3">
                    <div class="metric-label">Redemption Rate</div>
                    <div class="metric-value" style="font-size: 2rem;">{{ loyalty_metrics.redemption_rate }}%</div>
                </div>
                <div class="col-12">
                    <div class="metric-label">Active Participants</div>
                    <div class="metric-value" style="font-size: 2rem;">{{ loyalty_metrics.active_participants }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Report Links -->
<div class="report-links">
    <a href="{% url 'reports:revenue' %}?period={{ period }}" class="report-link-card">
        <i class="bi bi-currency-dollar"></i>
        <h4>Revenue Report</h4>
        <p>Detailed revenue analysis and breakdowns</p>
    </a>
    
    <a href="{% url 'reports:customers' %}?period={{ period }}" class="report-link-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <i class="bi bi-people"></i>
        <h4>Customer Report</h4>
        <p>Customer insights and segmentation</p>
    </a>
    
    <a href="{% url 'reports:sales' %}?period={{ period }}" class="report-link-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
        <i class="bi bi-graph-up-arrow"></i>
        <h4>Sales Report</h4>
        <p>Transaction trends and analytics</p>
    </a>
    
    <a href="{% url 'reports:loyalty' %}?period={{ period }}" class="report-link-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
        <i class="bi bi-star-fill"></i>
        <h4>Loyalty Report</h4>
        <p>Loyalty program effectiveness</p>
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Revenue Trend Chart
const revenueData = {{ revenue_by_day|safe }};
const labels = Object.keys(revenueData);
const values = Object.values(revenueData);

const ctx = document.getElementById('revenueChart');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'Revenue ({{ currency_symbol }})',
            data: values,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 3,
            tension: 0.4,
            fill: true,
            pointRadius: 5,
            pointBackgroundColor: '#667eea',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointHoverRadius: 7
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: '#2c3e50',
                padding: 12,
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: '#667eea',
                borderWidth: 2,
                displayColors: false,
                callbacks: {
                    label: function(context) {
                        return '{{ currency_symbol }}' + context.parsed.y.toLocaleString(undefined, {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '{{ currency_symbol }}' + value.toLocaleString();
                    }
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    maxRotation: 45,
                    minRotation: 45
                }
            }
        }
    }
});
</script>
{% endblock %}
