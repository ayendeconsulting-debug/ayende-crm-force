{% extends 'reports/base.html' %}
{% load static %}

{% block title %}Loyalty Program Report - {{ tenant.name }}{% endblock %}

{% block extra_css %}
<style>
    .report-header {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
    }
    
    .report-card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        margin-bottom: 25px;
    }
    
    .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }
    
    .metric-box {
        text-align: center;
        padding: 25px;
        border-radius: 10px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2c3e50;
        margin: 10px 0;
    }
    
    .metric-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
    }
    
    .chart-container {
        position: relative;
        height: 350px;
        margin-top: 20px;
    }
    
    .customer-card {
        display: flex;
        align-items: center;
        padding: 15px;
        border-radius: 10px;
        background: linear-gradient(135deg, #f5f7fa 0%, #e8f5e9 100%);
        margin-bottom: 12px;
        transition: all 0.3s;
    }
    
    .customer-card:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(67, 233, 123, 0.2);
    }
    
    .customer-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.2rem;
        margin-right: 15px;
    }
    
    .customer-info {
        flex-grow: 1;
    }
    
    .customer-name {
        font-weight: 600;
        margin-bottom: 3px;
    }
    
    .points-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 15px;
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        color: #333;
        font-weight: 700;
        font-size: 0.9rem;
    }
    
    .progress-bar-custom {
        height: 30px;
        border-radius: 15px;
        background: #e9ecef;
        overflow: hidden;
        margin-bottom: 15px;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        transition: width 0.5s;
    }
    
    .reward-item {
        padding: 15px;
        border-radius: 10px;
        background: #f8f9fa;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
</style>
{% endblock %}

{% block content %}
<!-- Report Header -->
<div class="report-header">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h1><i class="bi bi-star-fill"></i> Loyalty Program Report</h1>
            <p style="opacity: 0.9; margin-bottom: 0;">
                Program effectiveness and performance metrics
            </p>
        </div>
        <a href="{% url 'reports:dashboard' %}" class="btn btn-light">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>

<!-- Key Loyalty Metrics -->
<div class="metric-grid mb-4">
    <div class="metric-box">
        <div class="metric-label">Points Issued</div>
        <div class="metric-value">{{ loyalty_metrics.total_points_issued|floatformat:0 }}</div>
    </div>
    
    <div class="metric-box">
        <div class="metric-label">Points Redeemed</div>
        <div class="metric-value">{{ loyalty_metrics.total_points_redeemed|floatformat:0 }}</div>
    </div>
    
    <div class="metric-box">
        <div class="metric-label">Current Balance</div>
        <div class="metric-value">{{ loyalty_metrics.current_points_balance|floatformat:0 }}</div>
    </div>
    
    <div class="metric-box">
        <div class="metric-label">Redemption Rate</div>
        <div class="metric-value">{{ loyalty_metrics.redemption_rate }}%</div>
    </div>
    
    <div class="metric-box">
        <div class="metric-label">Active Participants</div>
        <div class="metric-value">{{ loyalty_metrics.active_participants }}</div>
    </div>
</div>

<!-- Redemption Rate Visualization -->
<div class="report-card">
    <h3><i class="bi bi-graph-up"></i> Redemption Rate</h3>
    <p class="text-muted">Percentage of points issued that have been redeemed</p>
    
    <div class="progress-bar-custom">
        <div class="progress-fill" style="width: {{ loyalty_metrics.redemption_rate }}%;">
            {{ loyalty_metrics.redemption_rate }}%
        </div>
    </div>
    
    <div class="row text-center">
        <div class="col-md-6">
            <h5>Points Issued</h5>
            <p class="display-6">{{ loyalty_metrics.total_points_issued|floatformat:0 }}</p>
        </div>
        <div class="col-md-6">
            <h5>Points Redeemed</h5>
            <p class="display-6">{{ loyalty_metrics.total_points_redeemed|floatformat:0 }}</p>
        </div>
    </div>
</div>

<!-- Points Distribution -->
<div class="report-card">
    <h3><i class="bi bi-pie-chart"></i> Points Distribution by Customer Segment</h3>
    
    <div class="row">
        <div class="col-md-6">
            {% for range in points_ranges %}
            <div style="margin-bottom: 20px;">
                <div class="d-flex justify-content-between mb-2">
                    <span><strong>{{ range.range }} points</strong></span>
                    <span>{{ range.count }} customers</span>
                </div>
                <div class="progress" style="height: 25px;">
                    {% widthratio range.count loyalty_metrics.active_participants 100 as percentage %}
                    <div class="progress-bar" role="progressbar" 
                         style="width: {{ percentage }}%; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        {{ percentage }}%
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="col-md-6">
            <div class="chart-container" style="height: 300px;">
                <canvas id="distributionChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Points Timeline -->
<div class="report-card">
    <h3><i class="bi bi-clock-history"></i> Points Issued vs Redeemed Over Time</h3>
    <div class="chart-container">
        <canvas id="timelineChart"></canvas>
    </div>
</div>

<!-- Top Point Earners -->
<div class="report-card">
    <h3><i class="bi bi-trophy"></i> Top Point Earners</h3>
    
    <div class="row">
        {% for customer in top_earners %}
        <div class="col-lg-6 mb-3">
            <div class="customer-card">
                <div class="customer-avatar">
                    {{ customer.customer.first_name|first }}{{ customer.customer.last_name|first }}
                </div>
                <div class="customer-info">
                    <div class="customer-name">{{ customer.customer.get_full_name }}</div>
                    <div style="font-size: 0.85rem; color: #6c757d;">
                        {{ customer.customer.email }}
                    </div>
                </div>
                <div class="points-badge">
                    <i class="bi bi-star-fill"></i> {{ customer.loyalty_points }} pts
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <p class="text-muted text-center">No active participants yet</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Most Popular Rewards -->
{% if rewards_available %}
<div class="report-card">
    <h3><i class="bi bi-gift"></i> Most Popular Rewards</h3>
    
    {% if popular_rewards %}
    {% for reward in popular_rewards %}
    <div class="reward-item">
        <div>
            <strong>{{ reward.reward__name }}</strong>
        </div>
        <div>
            <span class="badge bg-success">{{ reward.count }} redemptions</span>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <p class="text-muted">No rewards redeemed yet</p>
    {% endif %}
</div>
{% endif %}

<!-- Program Effectiveness Insights -->
<div class="report-card">
    <h3><i class="bi bi-lightbulb"></i> Program Insights & Recommendations</h3>
    
    <div class="row">
        <div class="col-md-6">
            <h5>Performance Highlights</h5>
            <ul style="line-height: 2;">
                <li>{{ loyalty_metrics.active_participants }} customers actively earning points</li>
                <li>{{ loyalty_metrics.redemption_rate }}% redemption rate 
                    {% if loyalty_metrics.redemption_rate < 30 %}
                        <span class="badge bg-warning">Low - Consider promoting rewards</span>
                    {% elif loyalty_metrics.redemption_rate < 60 %}
                        <span class="badge bg-info">Moderate - Good engagement</span>
                    {% else %}
                        <span class="badge bg-success">Excellent - High engagement</span>
                    {% endif %}
                </li>
                <li>{{ loyalty_metrics.current_points_balance|floatformat:0 }} points currently in circulation</li>
            </ul>
        </div>
        
        <div class="col-md-6">
            <h5>Recommendations</h5>
            <ul style="line-height: 2;">
                {% if loyalty_metrics.redemption_rate < 30 %}
                <li>Create more attractive rewards to increase redemptions</li>
                <li>Send targeted promotions about available rewards</li>
                {% elif loyalty_metrics.redemption_rate > 70 %}
                <li>Consider adjusting reward costs to maintain balance</li>
                <li>Introduce premium rewards for high-value customers</li>
                {% endif %}
                <li>Encourage inactive customers to start earning points</li>
                <li>Highlight loyalty benefits in marketing materials</li>
                {% if rewards_available %}
                <li>Analyze most popular rewards to guide future offerings</li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Points Distribution Chart
const ctx1 = document.getElementById('distributionChart');
new Chart(ctx1, {
    type: 'doughnut',
    data: {
        labels: [
            {% for range in points_ranges %}
            '{{ range.range }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            data: [
                {% for range in points_ranges %}
                {{ range.count }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            backgroundColor: [
                '#43e97b',
                '#38f9d7',
                '#7be495',
                '#a8e6cf'
            ],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Points Timeline Chart
const timelineData = {{ points_timeline|safe }};
const timeLabels = Object.keys(timelineData);
const issuedData = timeLabels.map(month => timelineData[month].issued);
const redeemedData = timeLabels.map(month => timelineData[month].redeemed);

const ctx2 = document.getElementById('timelineChart');
new Chart(ctx2, {
    type: 'line',
    data: {
        labels: timeLabels,
        datasets: [
            {
                label: 'Points Issued',
                data: issuedData,
                borderColor: '#43e97b',
                backgroundColor: 'rgba(67, 233, 123, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true
            },
            {
                label: 'Points Redeemed',
                data: redeemedData,
                borderColor: '#38f9d7',
                backgroundColor: 'rgba(56, 249, 215, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top'
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
</script>
{% endblock %}
